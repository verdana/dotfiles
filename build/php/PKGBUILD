# $Id: $
# Maintainer: Verdana Mu <verdana.cn@gmail.com>

pkgname=php5
pkgver=5.5.6
pkgrel=1
pkgdesc='PHP 5.5'
arch=('i686' 'x86_64')
url='http://snaps.php.net'
license=('PHP')

makedepends=('freetype2' 'libjpeg' 'libmcrypt' 'libpng'
             'libvpx' 'libxml2' 'libxpm' 'libxslt'
             'net-snmp' 're2c' 'sqlite3' 'tidyhtml')

source=('php-5.5.6.tar.bz2::http://us2.php.net/get/php-5.5.6.tar.bz2/from/jp1.php.net/mirror'
        'php.ini-development.patch'
        'php-fpm.conf.in.patch'
        'php-fpm.service.in.patch'
        'php-fpm.socket')

md5sums=('1472b1f968a2a4ae8b26f3134a116011'
         'eea8a9a8c10067de292b75f9cd5538b6'
         '52a2ac00203c3597a5bd0640d3902222'
         '60fbba3f654c19f02edb19891d01796c'
         'cebca26f604ca239cf8ef705323acab6')

_phpsrc=''

prepare() {
    # parse source directory name
    cd ${srcdir}
    _phpsrc=`ls | grep ^php-\[0-9.\]\*$`
    msg2 "PHP Source directory : ${_phpsrc}"

    # patch the service file
    cd ${_phpsrc}
    patch -p0 -i ${srcdir}/php.ini-development.patch
    patch -p0 -i ${srcdir}/php-fpm.conf.in.patch
    patch -p0 -i ${srcdir}/php-fpm.service.in.patch
}

build() {
    local _core="
        --srcdir=../${_phpsrc} \
        --config-cache \
        --prefix=/usr/local \
        --bindir=/usr/local/bin \
        --sbindir=/usr/local/bin \
        --sysconfdir=/etc/php \
        --localstatedir=/var \
        --with-config-file-path=/etc/php \
        --with-config-file-scan-dir=/etc/php/conf.d \
        --disable-rpath \
        --mandir=/usr/local/share/man \
        --without-pear \
        "

    local _extensions="
        --enable-exif \
        --enable-fpm \
        --enable-gd-jis-conv \
        --enable-gd-native-ttf \
        --enable-mbstring \
        --enable-mysqlnd \
        --enable-opcache \
        --enable-pcntl \
        --enable-phar \
        --enable-sockets \
        --enable-sysvmsg \
        --enable-sysvsem \
        --enable-sysvshm \
        --enable-zip \
        --with-bz2 \
        --with-curl \
        --with-fpm-systemd \
        --with-freetype-dir=/usr \
        --with-gd \
        --with-gettext \
        --with-iconv-dir=/usr \
        --with-icu-dir=/usr \
        --with-jpeg-dir=/usr \
        --with-vpx-dir=/usr \
        --with-mcrypt \
        --with-mhash \
        --with-mysql=mysqlnd \
        --with-mysql-sock=/run/mysqld/mysqld.sock \
        --with-mysqli=mysqlnd \
        --with-openssl \
        --with-pcre-regex=/usr \
        --with-pdo-mysql \
        --with-pdo-sqlite=/usr \
        --with-png-dir=/usr \
        --with-readline \
        --with-snmp \
        --with-sqlite3=/usr \
        --with-tidy \
        --with-xmlrpc \
        --with-xsl \
        --with-zlib
        "
    # specify the extension dir
    EXTENSION_DIR=/usr/local/lib/php/modules
    export EXTENSION_DIR

    # php core
    [ ! -d ${srcdir}/build ] && mkdir ${srcdir}/build
    cd ${srcdir}/build

    [ ! -h configure ] && ln -s ../${_phpsrc}/configure
    ./configure ${_core} ${_extensions}

    # copy php.ini to build dir
    cp ${srcdir}/${_phpsrc}/php.ini-development ${srcdir}/build
}

package() {
    pkgdesc='The latest development for PHP5.5'
    backup=(
        'etc/php/php-fpm.conf'
        'etc/php/php.ini'
    )

    cd ${srcdir}/build
    make -j4 INSTALL_ROOT=${pkgdir} install

    # Install php.ini
    install -D -m644 php.ini-development                       ${pkgdir}/etc/php/php.ini
    install -d -m755 ${pkgdir}/etc/php/conf.d/

    # Install php-fpm
    install -d -m755 ${pkgdir}/etc/php/fpm.d/
    install -D -m644 ${srcdir}/build/sapi/fpm/php-fpm.conf     ${pkgdir}/etc/php/php-fpm.conf

    # Systemd service
    install -D -m644 ${srcdir}/build/sapi/fpm/php-fpm.service  ${pkgdir}/usr/lib/systemd/system/php-fpm.service
    install -D -m644 ${srcdir}/php-fpm.socket                  ${pkgdir}/usr/lib/systemd/system/php-fpm.socket
}

# vim: set fdm=marker ff=unix sw=4 ts=4 et:

